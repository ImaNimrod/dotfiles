#!/bin/sh

set -euo pipefail

readonly WALLPAPER_DIR="${XDG_DATA_HOME:-$HOME/.local/share/}/wallpapers"

if [[ -n "${1-}" ]]; then
    if [[ "$1" == "random" ]]; then
        random=$(find "$WALLPAPER_DIR" -iregex '.*.\(jpg\|jpeg\|png\|gif\)' -type f -printf "%f\n" | shuf -n 1)
        xwallpaper --zoom "$WALLPAPER_DIR/$random"
        chosen_wallpaper="$WALLPAPER_DIR/$random"
    elif [[ -e "$1" ]]; then
        xwallpaper --zoom "$1"
        chosen_wallpaper="$1"
    else
        notify-send "Failed to set wallpaper:" "File does not exist"
        exit 1
    fi

    wal -enq -b "000000" --saturate 0.4 -i "$chosen_wallpaper" -o "postwal"
    xrdb -merge ~/.Xresources
else
    chosen_wallpaper=$(echo -e "Random\n$(ls -v "$WALLPAPER_DIR")" | dmenu -c -i -l 15 -p "Choose a wallpaper: " || exit 1)

    if [[ "$chosen_wallpaper" == "Random" ]]; then
        chosen_wallpaper=$(find "$WALLPAPER_DIR" -iregex '.*.\(jpg\|jpeg\|png\|gif\)' -type f -printf "%f\n" | shuf -n 1)
        xwallpaper --zoom "$WALLPAPER_DIR/$chosen_wallpaper"
    else
        xwallpaper --zoom "$WALLPAPER_DIR/$chosen_wallpaper"
    fi

    wal -enq -b "000000" --saturate 0.4 -i "$WALLPAPER_DIR/$chosen_wallpaper" -o "postwal"
    xrdb -merge ~/.Xresources
    notify-send "Wallpaper set:" "$chosen_wallpaper"
fi
